name: Production Deployment

on:
  push:
    branches:
      - main

jobs:
  notify-start:
    name: Notify Deployment Start
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸš€ *Production Deployment Started*\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}\n*Workflow:* ${{ github.workflow }}\n*Run:* ${{ github.run_number }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi

  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

  detect-changed-workers:
    name: Detect Changed Workers
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      workers: ${{ steps.detect.outputs.workers }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect changed workers
        id: detect
        env:
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}
          GITHUB_EVENT_AFTER: ${{ github.event.after }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          echo "GitHub event before: $GITHUB_EVENT_BEFORE"
          echo "GitHub event after: $GITHUB_EVENT_AFTER"
          echo "GitHub SHA: $GITHUB_SHA"
          # Run script - only capture stdout (JSON), stderr goes to logs
          # Script outputs JSON to stdout and logs to stderr
          set +e  # Don't exit on error
          WORKERS_RAW=$(node scripts/detect-changed-workers.js 2>/dev/null)
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          # If script failed or output is empty, use empty array
          if [ $EXIT_CODE -ne 0 ] || [ -z "$WORKERS_RAW" ]; then
            echo "Script failed or returned empty, using empty array"
            WORKERS='[]'
          else
            # Extract only the JSON array line (should be the last line that matches pattern)
            # Use grep to find lines that are JSON arrays, take the last one
            WORKERS=$(echo "$WORKERS_RAW" | grep -E '^\[.*\]$' | tail -1)
            
            # If no valid JSON found, use empty array
            if [ -z "$WORKERS" ] || ! echo "$WORKERS" | grep -qE '^\[.*\]$'; then
              echo "Warning: Could not extract valid JSON array, using empty array"
              echo "Raw output was: $WORKERS_RAW"
              WORKERS='[]'
            else
            # Remove any trailing whitespace/newlines
            WORKERS=$(printf '%s' "$WORKERS" | tr -d '\n\r')
            fi
          fi
          
          # Final validation: ensure it's not empty
          if [ -z "$WORKERS" ]; then
            WORKERS='[]'
          fi
          
          # Validate JSON syntax using Python (if available)
          if command -v python3 &> /dev/null; then
            if ! echo "$WORKERS" | python3 -m json.tool >/dev/null 2>&1; then
              echo "Warning: Invalid JSON syntax, using empty array"
              WORKERS='[]'
            fi
          fi
          
          # Output to GitHub Actions - use multiline format for reliability
          # Ensure JSON is on a single line with no trailing newline
          WORKERS_CLEAN=$(printf '%s' "$WORKERS")
          
          # Debug: Show what we're outputting
          echo "DEBUG: Workers JSON length: ${#WORKERS_CLEAN}"
          echo "DEBUG: Workers JSON preview: ${WORKERS_CLEAN:0:50}..."
          
          # Output using multiline format (EOF delimiter)
          {
            echo "workers<<EOF"
            printf '%s' "$WORKERS_CLEAN"
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "Changed workers: $WORKERS_CLEAN"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: detect-changed-workers
    if: needs.detect-changed-workers.outputs.workers != '[]' && needs.detect-changed-workers.outputs.workers != ''
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changed-workers.outputs.workers || '[]') }}
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy ${{ matrix.worker }} to production
        run: node scripts/deploy-worker.js ${{ matrix.worker }} production

      - name: Wait for deployment
        run: sleep 10

      - name: Health check ${{ matrix.worker }}
        id: health
        continue-on-error: true
        env:
          # Set worker URL from secrets or use default
          WORKER_URL: ${{ secrets[format('{0}_WORKER_URL', matrix.worker)] }}
        run: |
          node scripts/health-check.js ${{ matrix.worker }} production || exit 1

      - name: Rollback on health check failure
        if: steps.health.outcome == 'failure'
        run: |
          echo "âŒ Health check failed for ${{ matrix.worker }}, rolling back..."
          node scripts/rollback-worker.js ${{ matrix.worker }} production || true
          exit 1

  notify-completion:
    name: Notify Deployment Completion
    runs-on: ubuntu-latest
    needs: [notify-start, detect-changed-workers, deploy-production]
    if: always()
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Production deployment completed successfully!" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-production.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Production deployment failed!" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-production.result }}" == "cancelled" ]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Production deployment was cancelled!" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "emoji=â­ï¸" >> $GITHUB_OUTPUT
            echo "message=Production deployment was skipped (no changes detected)" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            WORKERS="${{ needs.detect-changed-workers.outputs.workers }}"
            WORKERS_COUNT=$(echo "$WORKERS" | grep -o ',' | wc -l | xargs)
            WORKERS_COUNT=$((WORKERS_COUNT + 1))
            
            if [ "${{ needs.deploy-production.result }}" == "skipped" ] || [ -z "$WORKERS" ] || [ "$WORKERS" == "[]" ]; then
              WORKERS_TEXT="No workers changed"
            else
              WORKERS_TEXT="$WORKERS_COUNT worker(s): $WORKERS"
            fi
            
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${{ steps.status.outputs.emoji }} *Production Deployment ${{ steps.status.outputs.status }}*\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${GITHUB_SHA:0:7}>\n*Author:* ${{ github.actor }}\n*Workflow:* ${{ github.workflow }}\n*Run:* ${{ github.run_number }}\n*Workers:* $WORKERS_TEXT\n*Status:* ${{ steps.status.outputs.message }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi

